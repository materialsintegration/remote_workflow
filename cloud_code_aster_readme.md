# 概要
本文書は、外部計算機資源機能を利用した、code_aster計算のクラウドタイプによる外部計算機資源実行の検証を行ったときの報告書となる。

本機能を利用したワークフローを実行するには以下の資材が必要となる。

* MIntシステム

    - 本リポジトリ（すでに存在している）
    - WFASリポジトリ（すでに存在している）
    - 下記外部計算機およびクラウドインスタンスへのパスワード無しログインの設定
* クラウドインスタンス作成用外部計算機

    - 本リポジトリの展開
    - クラウドインスタンスソースにcode_asterのインストール
    - クラウドインスタンス作成スクリプト(詳細は後述）
    - ssh接続できることが望ましい

## 実行の流れ
実行は以下のような流れとなる。

1. 予測モジュール実行開始
2. 榎研経由でインスタンス作成。IPアドレス返却
3. 榎研アカウントへログイン
4. インスタンスへ資材送付
5. インスタンスでcode_aster実行
6. code_aster実行終了後、インスタンスから結果の返却
7. 榎研アカウントから結果の返却
8. 予測モジュール実行終了

## 本検証における方針
本検証に置いて特別に考慮すべき事項についてあらかじめ方針を決めておいた。

* インスタンスは予測モジュール毎に生成、消滅を行い、再利用しない
* 本検証はSSH接続による方式を選択する。
* SIP-MIラボではAWSなどのクラウド利用は行ってないので、伊藤さん所属の榎研のサーバーおよびAWSを利用させていただいた。

# 準備

概要に書いた資材のうち、クラウドインスタンス作成用外部計算機について記述する。

## パスワード無しログインの設定

これは公開鍵暗号方式を利用し、~/.ssh/configファイルに設定を実施した。これをMInt側、計算機stnode02と榎研に作成していただいたアカウントの両方に設定して対応した。

※ 公開鍵暗号はRSAタイプを指定した。

## 本リポジトリの展開

MIntシステムのモジュール（WFAS6_code_aster_実行_外部計算機資源利用)が実行されると、
このリポジトリ/scripts/execute_remote_command_code_aster_execute.sh がssh経由で実行される。

## code_asterのインストール

クラウドタイプは実行前にインスタンスを作成する。そのため作成後にインストールするのは現実的ではないので、あらかじめcode_asterがインストールされたインスタンスが作成される用に準備する。
インストール資材はshareディレクトリにある。
現在のバージョンは2018である。

## クラウドインスタンス作成スクリプト

code_asterがインストールされたインスタンスを作成するためにある程度、専用のスクリプトになると思われる。
また作成後はそこへアクセスの必要があるため、スクリプトは正常終了した場合、IPアドレスを返すようにする。

※ 今回の検証では、外部計算機は東大榎研の計算機にアカウントを作成してただき、
AWSインスタンス作成スクリプトも用意されているものを小改造して提供していただいた。

## WFASリポジトリに専用資材
MIntシステムはユーザーまたはユーザーグループ単位で専用となるため、予測モジュールと実行スクリプトは専用のものとなる。この検証では以下の資材を作成した。

* 予測モジュール：P000119040000287（本リポジトリ/modulesxml/prediction-P000119040000287.xml）
* 実行スクリプト：wfas_for_api_workflow/scripts6/codeaster_execute_remote.py

※ 可視化のためのモジュールWFAS6_code_aster_更新は外部計算資源機能を利用していないので、従来の予測モジュール、実行スクリプトを利用している。

# 検証実施期間
2021年12月13日～16日。

検証はインスタンス作成とIPアドレス返却が行われないと実行不可能となるため、その周辺に重点を置いて行われた。
IPアドレス返却が行われ無かった場合、インスタンスが生成できなかった場合などを想定して予測モジュール実行スクリプトは作成された。

## 検証結果
検証は当初の目的を達成したが、問題点もいくつか発生した。

* 問題点
  + インスタンス作成時間
    - 最短でも1分はかかるので、本体実行がこれを問題ないレベルと思われるくらいに長い計算が望ましい。
  + インスタンス作成
    - インスタンス作成はかなり複雑なので、榎研のようにあらかじめスクリプトが用意されていないと利用のためのハードルが高い可能性がある。

