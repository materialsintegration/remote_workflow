
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>1. はじめに &#8212; 外部計算資源の利用について 1.0.1 ドキュメント</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="prev" title="外部計算資源の利用方法（本運用）" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1><span class="section-number">1. </span>はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>MIntには、ワークフローを構成するモジュール内の一部分の処理を、MIntの計算ノード以外の「外部計算機」に行わせる機能がある。本機能によって、ユーザには下記に挙げる利点がある。</p>
<ul class="simple">
<li><p>秘匿プログラムの使用</p></li>
<li><p>秘匿データの使用</p></li>
<li><p>特殊構成 (MIntの計算ノードでは対応できない) の計算機を使用できる</p></li>
<li><p>商用ソフトの使用 (MIntの計算ノードにも商用ソフトがインストールされているが、ライセンスの規定上、ほとんどの場合NIMS外からは利用できない)</p></li>
</ul>
<p>外部計算資源の利用に際しては、MInt、外部計算機の双方が後述のセキュリティ水準を満たす必要がある。</p>
<ol class="arabic">
<li><p>MIコンソーシアム会則（秘密保持誓約書含む）、MIntシステム利用規定など、MInt利用に関わる契約・規定を遵守すること。</p></li>
<li><p>MInt側は、下記のセキュリティ対策を実施すること。</p>
<blockquote>
<div><ul class="simple">
<li><p>第三者によるMIntのセキュリティ分析・セキュリティリスク診断を実施し、リスクを避ける設計を維持すること。</p></li>
<li><p>MIntを構成するサーバのOS・ミドルウェア・ライブラリ等に対し、継続的に脆弱性データベースを確認し、必要なアップデートを実施すること。</p></li>
<li><p>不正アクセス監視やネットワーク負荷監視を実施すること。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>外部計算機側は、外部計算機として利用されるコンピュータに対し、十分なセキュリティ対策を実施すること。継続的に利用する場合には、定期的に対策状況を確認し、セキュリティレベルを維持すること。</p></li>
</ol>
<p>外部計算資源利用には、SSH方式とWebAPI方式がある。
前者はMIntから外部計算機へSSHで必要なデータとコマンドをプッシュする方式である。
単純で、外部計算を遅延なく開始できる利点があるが、外部計算機側でMIntに対しSSHのポートを開放してプッシュを受け入れる必要がある点は、特に企業ユーザではハードルが高いことが想定される。
これに対し、後者は数分間隔で外部計算機側からMIntにWebAPI(https)でポーリングし、処理すべき案件が存在した場合は、必要なデータとコマンドがプルされる方式である。
この方式では外部計算機側にポート開放の必要が無いが、外部計算の開始までにポーリング間隔に相当する遅延が生じる。</p>
<p>本機能は外部計算機内にユーザが持つ秘匿データの扱いにも十分な配慮が行われている。
まず、ユーザが持つ秘匿データに関して、MIntが収集する情報はワークフローの各モジュールの入出力ポートの情報のみであり、モジュールの内部で完結する本機能のために、モジュールと外部計算機の間で送受信される情報は収集対象外である。
外部計算機側は、MIntにあらかじめ定められたコマンドのみ実行できるように設定することができる。
また、MIntに処理結果を返送する前に不必要なデータをワーキングディレクトリから削除することができる。</p>
<p>上記の機構によって、安全な外部計算が保証される。下記の各章で具体的な利用方法について記す。
また、外部計算資源の利用に際して本書では不明な点は、ユーザとMInt運用チームとの協議で決定するものとする。</p>
<div class="section" id="id2">
<h2><span class="section-number">1.1. </span>本書の対象<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id3">
<h3><span class="section-number">1.1.1. </span>対象読者<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>本文書は既にMIntシステムのユーザーであり、これから外部計算資源を利用したワークフローの実行を行おうとしている方(以下利用者とする）を想定して記述しています。</p>
<p>対象読者は以下の知識を有しているか、知識を有している担当者が存在していることを前提としています。</p>
<ul class="simple">
<li><p>Linux(主にCentOS 7.x)の仕組みやコマンドについての基本的な知識</p></li>
<li><p>オープンソースソフトウェアを扱う、基本的な知識</p></li>
<li><p>MIntシステムのワークフローの操作、ランの実行などの基本的な知識</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3><span class="section-number">1.1.2. </span>対象範囲<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>本文書ではこれから外部計算機資源を利用した既存のワークフローの実行を行うための情報を元に記述されている。MIntシステムに存在しない外部計算機資源を利用することを想定した予測モジュールやワークフローの新規作成に関する情報は記述しない。また外部計算機資源として利用者が用意する計算機(以下外部計算機と言う)で動作するプログラムはNIMS側での動作実績のあるものを対象とし、新規作成した上で外部計算機資源として利用する場合の情報も記述しない。（注：これはら別途「」に記述する。）</p>
<p>この他、外部計算機に展開する予測モジュール用の資材の詳細についてはその予測モジュールまたはワークフローの利用者マニュアルを参照することとし、本書では扱わない。</p>
</div>
</div>
</div>
<div class="section" id="id5">
<h1><span class="section-number">2. </span>概要<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id6">
<h2><span class="section-number">2.1. </span>利用イメージ<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算資源の利用イメージを( <a class="reference internal" href="#image-for-use-eps"><span class="std std-numref">図 2.1</span></a> )に示す。</p>
<ul class="simple">
<li><p>MIntはNIMS構内のDMZ <a class="footnote-reference brackets" href="#whatisdmz" id="id7">1</a> に存在する。</p></li>
<li><p>ユーザはMInt上に、外部計算を利用するモジュールを含んだワークフローを持つ。当該モジュールやワークフローの参照・実行権限は自機関内などに限定できる。</p></li>
<li><p>ユーザが当該ワークフローを実行すると、外部計算を利用するモジュールで一部の処理が外部計算機に受け渡される。</p></li>
<li><p>外部計算機は処理の過程で、MIntに置けないデータやプログラムにアクセスできる。これらのアクセスを外部計算機の内部で完結させることで、安全な利用が可能となる。</p></li>
</ul>
 <A HREF="_images/remote_execution_image.png"><img src="_images/remote_execution_image.png" /></A>

外部計算資源の利用イメージ<div class="figure align-center" id="image-for-use-eps">
<a class="reference internal image-reference" href="_images/image_for_use.eps"><img alt="_images/image_for_use.eps" src="_images/image_for_use.eps" style="width: 385.8px; height: 221.4px;" /></a>
<p class="caption"><span class="caption-number">図 2.1 </span><span class="caption-text">外部計算資源の利用イメージ</span><a class="headerlink" href="#image-for-use-eps" title="この画像へのパーマリンク">¶</a></p>
</div>
<dl class="footnote brackets">
<dt class="label" id="whatisdmz"><span class="brackets"><a class="fn-backref" href="#id7">1</a></span></dt>
<dd><p>物理的にはNIMS構内のサーバ室に存在するが、ネットワーク的には機構内LANとインターネットの双方からファイアウォールで切り離された領域。</p>
</dd>
</dl>
</div>
<div class="section" id="sshwebapi">
<h2><span class="section-number">2.2. </span>SSH方式とWebAPI方式の比較<a class="headerlink" href="#sshwebapi" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>SSH方式</dt><dd><ul>
<li><p>MIntからSSHで外部計算機にアクセスし、必要なファイルとコマンドをプッシュし、コマンドを発行し、結果を得る。</p></li>
<li><p>ファイルは内部でrsync -avを利用して送受信され、サイズは無制限である。</p></li>
<li><p>コマンドラインなどの文字列はBase64エンコード無しで送受信される。</p></li>
<li><p>外部計算機側SSHサーバのポート(TCP/22以外でも可)のインバウンドアクセスの開放が必要である。</p></li>
<li><p>通信障害には弱い。計算中などで通信が切れると復帰できず、本バージョンでは実行プロセスが簡易なため計算続行が不可能である。</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>WebAPI方式</dt><dd><ul>
<li><p>外部計算機からMIntのWebAPIサーバにポーリングを行い、要処理案件の有無を確認する。ポーリング間隔は数分程度を想定している。案件があれば必要なデータとコマンドをプルし、自らコマンドを実行し、APIで結果を送信する。</p></li>
<li><p>ファイルはBase64エンコードされ、サイズはエンコード後に2GiB <a class="footnote-reference brackets" href="#whatisgib" id="id8">2</a> 未満である必要がある。</p></li>
<li><p>コマンドラインなどの文字列はBase64エンコード無しで送受信される。</p></li>
<li><p>MIntのWebAPIサーバへのhttps(TCP/50443)のアウトバウンドアクセスの許可が必要である。</p></li>
<li><p>サーバー側クライアント側で状態を保持しているため、通信障害が起きても再接続と計算続行が可能である。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="whatisgib"><span class="brackets"><a class="fn-backref" href="#id8">2</a></span></dt>
<dd><p>GiB はギビバイトといい、コンピュータの容量や記憶装置の大きさを表す情報単位の一つである。1GiB は 2の30乗バイトであり、1,073,741,824Bである。</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="id9">
<h1><span class="section-number">3. </span>動作原理<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="ssh">
<h2><span class="section-number">3.1. </span>SSH方式<a class="headerlink" href="#ssh" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id10">
<h3><span class="section-number">3.1.1. </span>動作イメージ<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH 方式での外部資源利用のイメージを( <a class="reference internal" href="#ssh-project-create-flow"><span class="std std-numref">図 3.1</span></a> )に示す。</p>
<div class="figure align-center" id="id43">
<span id="ssh-project-create-flow"></span>
            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <script>mermaid.initialize({startOnLoad:true});</script><div class="mermaid">
            graph LR;

subgraph NIMS所外
  input3[\秘匿データ/]
  module21[専用プログラム実行]
  module22[データ返却]
end
subgraph MInt
  subgraph ワークフロー
    input1[\入力/]
    module11[SSH実行開始]
    module12[SSHデータ受け取り]
    module13[計算]
    output1[/出力\]
  end
end

input1--&gt;module11
module11--&gt;module12
module12--&gt;module13
module13--&gt;output1
input3--&gt;module21
module11--SSH経由--&gt;module21
module21--&gt;module22
module22--SSH経由--&gt;module12
        </div><p class="caption"><span class="caption-number">図 3.1 </span><span class="caption-text">SSH方式の外部資源利用のイメージ</span><a class="headerlink" href="#id43" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id11">
<h3><span class="section-number">3.1.2. </span>ワークフロー例<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH方式の外部資源利用を含むワークフローを、MIntのワークフローデザイナで表示した例を示す。
赤枠の部分が遠隔実行の行われるモジュールである。
なお、本ワークフローは動作検証用サンプルとして、<a class="reference internal" href="#how-to-use"><span class="std std-numref">4 章</span></a>の<a class="reference internal" href="#how-to-use"><span class="std std-ref">利用のための準備</span></a> で説明するインストール資材に含まれている。</p>
<div class="figure align-center" id="id44">
<a class="reference internal image-reference" href="_images/workflow_with_sshmodule.png"><img alt="_images/workflow_with_sshmodule.png" src="_images/workflow_with_sshmodule.png" style="width: 796.0px; height: 441.6px;" /></a>
<p class="caption"><span class="caption-number">図 3.2 </span><span class="caption-text">動作検証用のワークフロー</span><a class="headerlink" href="#id44" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id12">
<h3><span class="section-number">3.1.3. </span>モジュール内の処理<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>外部資源利用を行うモジュール内で、外部計算機側の処理が実行されるまでの流れを下記に示す。</p>
<div class="figure align-center" id="id45">

            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

  participant A as モジュール
  participant B as プログラム（Ａ）
  participant C as プログラム（Ｂ）
  participant D as プログラム（Ｃ）
  participant E as プログラム（Ｄ）

  Note over A,C : MInt内
  Note over D,E : 外部計算機内

  A-&gt;&gt;B:モジュールが実行
  B-&gt;&gt;C:（Ａ）が実行
  C-&gt;&gt;D:（Ｂ）がSSH経由で外部計算機の（Ｃ）を実行
  D-&gt;&gt;E:（Ｃ）が実行
        </div><p class="caption"><span class="caption-number">図 3.3 </span><span class="caption-text">SSH接続経由によるコマンド実行の流れ</span><a class="headerlink" href="#id45" title="この画像へのパーマリンク">¶</a></p>
</div>
<ul>
<li><p>モジュール</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのワークフローシステムによって実行されるモジュール</p></li>
<li><p>プログラム（Ａ）を実行する</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ａ）</p>
<blockquote>
<div><ul class="simple">
<li><p>モジュールによって実行されるプログラム</p></li>
<li><p>モジュール固有の前処理を行う。</p></li>
<li><p>モジュールごとに任意の名前で用意する。</p></li>
<li><p><a class="reference internal" href="#how-to-use"><span class="std std-numref">4 章</span></a>の<a class="reference internal" href="#how-to-use"><span class="std std-ref">利用のための準備</span></a> で説明する編集を行う。</p></li>
<li><p>（Ｂ）を実行する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｂ） このプログラムが外部計算機と通信を行う。</p>
<blockquote>
<div><ul>
<li><p>外部計算の準備を行う。</p></li>
<li><p>名前は任意の名前を使用可能。</p></li>
<li><p>テンプレートは <strong>execute_remote_command.sample.sh</strong> をコピーして使用する。</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#how-to-use"><span class="std std-numref">4 章</span></a>の<a class="reference internal" href="#how-to-use"><span class="std std-ref">利用のための準備</span></a> で説明する編集を行う。</p></li>
<li><p>（Ａ）が実行するプログラム名とコピーしたプログラム名は同名としておく。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>SSH経由で（Ｃ）を実行する。</p>
<blockquote>
<div><ul class="simple">
<li><p>送信するファイルはパラメータとして記述する。</p></li>
<li><p>外部計算機上の一時ディレクトリ <a class="footnote-reference brackets" href="#calc-dir1" id="id13">3</a> の内容を全部受信するため、MIntに送信しないデータは外部計算機側で（Ｃ）の実行終了前に削除する。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｃ）</p>
<blockquote>
<div><ul>
<li><p>名前は プログラム（Ｂ）用のテンプレートで**execute_remote-side_program_ssh.sh** となっているが変更可能である。</p>
<blockquote>
<div><ul class="simple">
<li><p>同名のテンプレートが用意されているので、複雑な処理を必要とする場合は、コピーして使用する。</p></li>
<li><p>（Ｂ）で実行されるプログラム名とコピーしたプログラム名は同名としておく。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｄ）</p>
<blockquote>
<div><ul class="simple">
<li><p>外部計算機上のプログラムを（Ｃ）のみで完結させ、本スクリプト群は用意しない運用も可能である。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="calc-dir1"><span class="brackets"><a class="fn-backref" href="#id13">3</a></span></dt>
<dd><p>外部計算機では、処理は/tmpなどに作成した一時ディレクトリで実行される。</p>
</dd>
<dt class="label" id="sample-name1"><span class="brackets">4</span></dt>
<dd><p>本システムでは、MIntは <strong>execute_remote_command.sample.sh</strong> を実行し、外部計算機で実行するプログラムとして <strong>execute_remote-side_program_ssh.sh</strong> を呼び出す。外部計算機側ではインストール後にこのファイル（インストール直後は、execute_remote_program_ssh.sample.shと言う名前）を必要に応じて編集して使用することで、別なコマンドを記述することが可能になっている。</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="webapi">
<h2><span class="section-number">3.2. </span>WebAPI方式<a class="headerlink" href="#webapi" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id14">
<h3><span class="section-number">3.2.1. </span>動作イメージ<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPI方式での外部計算の実行イメージを( <a class="reference internal" href="#id15"><span class="std std-numref">図 3.4</span></a> )に示す。</p>
<div class="figure align-center" id="id46">
<span id="id15"></span>
            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

participant A as MInt&lt;BR&gt;
participant B as MInt WebAPIサーバ&lt;BR&gt;
participant C as WebAPI方式&lt;BR&gt;（外部計算機側）
participant D as ユーザープログラム&lt;BR&gt;（外部計算機側）


C-&gt;&gt;B:リクエスト
  alt 計算が存在しない
    B-&gt;&gt;C:ありません
    C --&gt;&gt; C:リクエスト継続
  else 計算が存在する
    A-&gt;&gt;B:計算要求
    C-&gt;&gt;B:リクエスト
    B-&gt;&gt;C:存在する
    C-&gt;&gt;B:情報取得リクエスト
    alt 計算実行
      B-&gt;&gt;C:パラメータ送付、コマンドライン送付
      C-&gt;&gt;D:プログラム実行
      alt プログラム実行
        D --&gt;&gt; D:プログラム実行中
      else プログラム終了
        D --&gt;&gt; C:プログラム終了
      end
      C-&gt;&gt;B:計算終了通知
    else no seq
    end
    B-&gt;&gt;C:計算結果の返却要求
    C-&gt;&gt;B:計算結果の返却応答
    B-&gt;&gt;A:ジョブの終了要求
  end
        </div><p class="caption"><span class="caption-number">図 3.4 </span><span class="caption-text">WebAPI方式の流れ</span><a class="headerlink" href="#id46" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id16">
<h3><span class="section-number">3.2.2. </span>ワークフロー例<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPI方式の外部資源利用を含むワークフローを、MIntのワークフローデザイナで表示した例を示す。
赤枠の部分が遠隔実行の行われるモジュールである。
なお、本ワークフローは動作検証用サンプルとして、<a class="reference internal" href="#how-to-use"><span class="std std-numref">4 章</span></a>の<a class="reference internal" href="#how-to-use"><span class="std std-ref">利用のための準備</span></a> で説明するインストール資材に含まれている。</p>
<div class="figure align-center" id="id47">
<a class="reference internal image-reference" href="_images/workflow_with_apimodule.png"><img alt="_images/workflow_with_apimodule.png" src="_images/workflow_with_apimodule.png" style="width: 965.0px; height: 519.0px;" /></a>
<p class="caption"><span class="caption-number">図 3.5 </span><span class="caption-text">検証用ワークフロー</span><a class="headerlink" href="#id47" title="この画像へのパーマリンク">¶</a></p>
</div>
<p>※赤枠の部分が外部計算資源を利用するモジュールである。</p>
</div>
<div class="section" id="id17">
<h3><span class="section-number">3.2.3. </span>モジュール内の処理<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ワークフローの当該モジュール内で外部計算機側の処理が実行されるまでの流れを下記に示す。</p>
<div class="figure align-center" id="id48">

            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

  participant A as モジュール
  participant B as プログラム（Ａ）
  participant C as WebAPI
  participant D as プログラム（Ｃ）
  participant E as プログラム（Ｄ）

  Note over A,C : MInt内
  Note over D,E : 外部計算機内

  A-&gt;&gt;B:モジュールが実行
  B-&gt;&gt;C:（Ａ）がhttps経由でAPI発行
  D-&gt;&gt;C:（Ｃ）がhttps経由でAPI発行
  D-&gt;&gt;E:（Ｃ）が実行
        </div><p class="caption"><span class="caption-number">図 3.6 </span><span class="caption-text">WebAPI方式でのコマンドの流れ</span><a class="headerlink" href="#id48" title="この画像へのパーマリンク">¶</a></p>
</div>
<ul>
<li><p>モジュール</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのワークフローシステムによって実行されるモジュール</p></li>
<li><p>プログラム（Ａ）を実行する</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ａ）</p>
<blockquote>
<div><ul class="simple">
<li><p>モジュールによって実行されるプログラム。モジュールごとに任意の名前で用意する。</p></li>
<li><p>モジュール固有の前処理を行う。</p></li>
<li><p><strong>misrc_distributed_computing_assist_api/debug/mi-system-side/mi-system-wf.py</strong> を実行しておく。
- WebAPIへ計算の情報が登録される。
- 以降このプログラムが外部計算機資源側（以下の（Ｃ）とAPIを介して計算を行う）</p></li>
</ul>
</div></blockquote>
</li>
<li><p>WebAPI (このプログラムがMIntシステムと外部計算機との通信を中継する。)</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>外部計算の準備を行う。</dt><dd><ul>
<li><p>送受信するファイルはパラメータとしてあらかじめ設定しておく。</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>WebAPI経由で（Ｃ）からのアクセスを受け付ける</p></li>
<li><p>（Ａ）から計算の情報登録が無い限り、（Ｃ）からアクセスがあっても計算は始まらない。</p></li>
<li><p>ワークフローを実行したユーザーのトークンと（Ｃ）からのトークンが合致しないと（Ｃ）は適正な通信相手とならない。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｃ）</p>
<blockquote>
<div><ul class="simple">
<li><p>ポーリングプログラムである。</p></li>
<li><p><strong>misrc_distributed_computing_assist_api/debug/remote-side/mi-system-remote.py</strong> を実行しておく。</p></li>
<li><p>外部計算機上で実行するプログラム名は、このプログラム経由でMIntシステムから受信され、このプログラムが実行する。</p></li>
<li><p>認証情報はこのプログラム（Ｃ）が使用する。認証情報が無いとWebAPIにアクセスできない。詳細は<code class="xref std std-numref docutils literal notranslate"><span class="pre">get_authorizaion_infomation</span></code>の<span class="xref std std-ref">get_authorizaion_infomation</span> で説明する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｄ）</p>
<blockquote>
<div><ul class="simple">
<li><p>（Ｃ）から実行される外部計算用スクリプト。</p></li>
<li><p>名前は任意。（プログラム（Ｃ）経由で伝えられるため、あらかじめMIntシステム側に設定が必要）</p></li>
<li><p><strong>execute_remote_command_api.sh</strong> を参考にして作成しておく。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="id18"></span><h1><span class="section-number">4. </span>利用のための準備<a class="headerlink" href="#how-to-use" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>SSH方式、WebAPI方式それぞれのインストールおよびプログラムの実行までを外部計算機側で作業が必要な項目について説明する。
なお、外部計算機側はbashスクリプトとPythonスクリプトの動作するLinux計算機を推奨している。ただしMInt側との通信が正常に確立でき、外部計算に必要なプログラムが実行可能であれば、これ以外の環境でも構わない。
その場合、こちらに無い情報は利用者側で適宜用意して使うこととなる。
また、外部計算機側で秘匿データを扱う際は、これに関する仕様をMInt側に開示する必要は無い。</p>
<div class="section" id="before-descide-items">
<span id="id19"></span><h2><span class="section-number">4.1. </span>事前確認<a class="headerlink" href="#before-descide-items" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>事前に以下の点を確認しておく。</p>
<ul>
<li><p>SSH方式またはWebAPI方式の選択</p></li>
<li><p>外部計算機の利用場所</p>
<blockquote>
<div><ul class="simple">
<li><p>自社内</p></li>
<li><p>NIMS内</p></li>
<li><p>AWSなどのクラウド</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id20">
<h2><span class="section-number">4.2. </span>利用申請<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算機資源を利用したワークフローの利用申請を行い、必要な認証情報の準備を行う。
このタイプのワークフローはユーザー専用となるため、その手続きが必要である。
申請後、専用ワークフローのワークフローIDが返送されるので、実行にはそのワークフローIDを利用する。</p>
<div class="section" id="id21">
<h3><span class="section-number">4.2.1. </span>公開鍵の用意<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH方式を選択した場合に必要になります。
SSH接続はMIntシステムから外部計算機に向けて行われます。
アクセスは公開鍵暗号方式を利用したパスワード無しログインで行われます。
公開鍵暗号はパスフレーズ無しの形式です。
MInt運用チームに依頼して、パスワードなしログイン用の公開鍵ファイルを入手し、以下の手順に沿ってファイルを作成しておきます。</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd .ssh
$ cat &lt;入手した公開鍵暗号ファイル&gt; &gt;&gt; authorized_keys
$ chmod 600 authorized_keys
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>.sshディレクトリが無い場合は作成する。パーミッションも600としておく。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ワークフロー実行前にMInt運用チームに連絡してパスワードなしログインが可能なことを確認すること</p>
</div>
</div>
<div class="section" id="api">
<h3><span class="section-number">4.2.2. </span>APIトークンの用意<a class="headerlink" href="#api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPIを選択した場合、認証情報として利用するユーザーのAPIトークンと識別子が必要になります。</p>
<ul class="simple">
<li><p>APIトークンはMIntシステムログイン後、ユーザープロファイル管理システムのページで取得可能</p></li>
<li><p>識別子は文字通りユーザーを識別するもので、通常利用者の所属組織のアルファベット表記などです。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>APIトークンと識別子はMIntシステム運用チームへもお知らせください。</p>
</div>
</div>
</div>
<div class="section" id="id22">
<h2><span class="section-number">4.3. </span>環境構築<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算機資源を利用した計算を行うMIntシステム外の計算機の環境構築について記述する。一般的に外部計算機資源を利用したいユーザーが構築する。手順は以下のとおり。</p>
<ul class="simple">
<li><p>OSの準備</p></li>
<li><p>ソルバーの準備（必要であれば）</p></li>
<li><p>pythonの準備</p></li>
<li><p>gitの準備</p></li>
<li><p>MIntシステム認証プログラム（WebAPIを選択し、APIトークンを利用しない場合）</p></li>
<li><p>予測モジュール用の資材の入手（個別の利用者マニュアルを参照）</p></li>
<li><p>外部計算機資源を利用するための資材の入手と展開</p></li>
</ul>
</div>
<div class="section" id="os">
<h2><span class="section-number">4.4. </span>OSの準備<a class="headerlink" href="#os" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>OSはLinux系のOSが望ましいが、利用者側で用意でき、外部計算機資源の利用が可能なOSであればLinuxに限らない。ただしその場合は利用者側が本書を読んで必要な環境を用意するものとする。</p>
</div>
<div class="section" id="ready-public-keys">
<span id="id23"></span><h2><span class="section-number">4.5. </span>ソルバーの準備<a class="headerlink" href="#ready-public-keys" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>利用したいワークフローによっては商用・非商用のソルバーが必要になる。商用の場合は利用者側でインストール、セットアップおよび動作確認を行うこととし、非商用の場合はMInt運用チームが構築スクリプトなどを提供する。</p>
</div>
<div class="section" id="python">
<h2><span class="section-number">4.6. </span>Pythonの準備<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>利用するワークフローの予測モジュールはpythonで記述されたスクリプトであることがあり、これを外部計算機にインストールして利用する。
対応するバージョンは3.xであるため、用意したOSに使用可能か確認する。
インストールされていない場合別途インストールする。
WebAPIを選択した場合は必須となる。</p>
<div class="section" id="id24">
<h3><span class="section-number">4.6.1. </span>バージョン確認<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>確認方法は以下のいずれかが表示されればインストールの必要はない。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3
Python 3.x.x ～
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python --version
Python 3.x.x ～
</pre></div>
</div>
<p>これ以外のバージョンが表示されない（コマンドが見つかりません or command not found）場合や、表示されても 2.x.x などと表示された場合はバージョン3.xのインストールが必要です。</p>
<p>※ python3.xの追加インストールの方法についてはOS個別となるため、利用者側のシステム管理者などにお尋ねください。</p>
</div>
<div class="section" id="id25">
<h3><span class="section-number">4.6.2. </span>追加のパッケージ<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>pip3.xコマンドを利用して以下のコマンドをインストールする。インストールはroot権限で行う。</p>
<ul class="simple">
<li><p>requests</p></li>
<li><p>urllib3</p></li>
</ul>
</div>
</div>
<div class="section" id="git">
<h2><span class="section-number">4.7. </span>gitの準備<a class="headerlink" href="#git" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算資源の利用に必要な資材は GitHub 上のリポジトリ <a class="footnote-reference brackets" href="#whatisrepository" id="id26">5</a> <a class="reference external" href="https://github.com/materialsintegration">https://github.com/materialsintegration</a> に用意されている。このれを取得するためにgitコマンドが必要となる。</p>
<div class="section" id="id27">
<h3><span class="section-number">4.7.1. </span>確認方法<a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>git コマンドを実行してコマンドが見つかりません or command not foundなどになった場合は、gitコマンドを別途インストールします。</p>
<p>※ インストールの方法についてはOS個別となるため、利用者側のシステム管理者などにお尋ねください。</p>
<p>上記の例では以下の様な環境変数の設定が必要となります。</p>
<ul class="simple">
<li><p>MATHEMATICA11_2：Mathematicaのインストールディレクトリ（例えば、/opt/Wolfram/Mathematica/11.2/Executablesなど）</p></li>
<li><p>BRITTLE_FRACTURE_HOME：上記&lt;展開したい場所&gt;で指定した場所をフルパスで指定します。（例えば/home/展開したい場所/misrc_brittle/facture_workflowとなる）</p></li>
<li><p>QT_QPA_PLATFORM：offscreen を指定する。</p></li>
</ul>
</div>
</div>
<div class="section" id="id28">
<h2><span class="section-number">4.8. </span>外部計算機資源を利用するため資材<a class="headerlink" href="#id28" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算機に入手、展開の必要な資材は以下。</p>
<ul class="simple">
<li><p>WebAPI用ポーリングプログラム（WebAPI方式を選択した場合）</p></li>
<li><p>MIntシステム認証プログラム（WebAPI方式の場合で、希望する場合のみ）</p></li>
<li><p>SSH用利用者側実行スクリプト集（SSH方式の場合）</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>SSH方式を選択した場合はWebAPI方式のような特別な資材は必要ありません。</p>
</div>
<div class="section" id="api-polling-program">
<span id="id29"></span><h3><span class="section-number">4.8.1. </span>WebAPI用ポーリングプログラム<a class="headerlink" href="#api-polling-program" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPI方式を選択した場合に必要になります。手順は公開している場所から以下の要領でgitコマンドを使用してダウンロード、展開します。</p>
<ul>
<li><p>手順</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd &lt;展開したい場所&gt;
$ git clone https://github.com/materialsintegration/misrc_distributed_computing_assist_remote_side.git
</pre></div>
</div>
</li>
<li><p>利用方法</p>
<ul>
<li><p>proxyサーバーの設定が必要であれば、設定する。(https_proxy環境変数）</p></li>
<li><p>外部計算機で、外部計算を行うユーザーで以下のコマンドを実行し、WebAPIのポーリング動作を実施します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd &lt;展開した場所&gt;/misrc_distributed_computing_assist_remote_side
$ python3 mi-system-remote.py &lt;識別子&gt; http://nims.mintsys.jp &lt;APIトークン&gt;
</pre></div>
</div>
</li>
<li><p>ポート番号はデフォルト50443を利用するが、これを利用できない場合通常のhttps通信用443を利用することができる。以下の様に実行する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd &lt;展開した場所&gt;/misrc_distributed_computing_assist_remote_side
$ python3 mi-system-remote.py &lt;識別子&gt; http://nims.mintsys.jp &lt;APIトークン&gt; port:443
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>動作確認</p>
<ul>
<li><p>正常動作時</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>site id = 指定した識別子
base url = https://nims.mintsys.jp:50443
 token = 指定したAPIトークン
年/月/日 時:分:秒:send https://nims.mintsys.jp:50443/mi-distcomp-api/calc-request?site_id=指定した識別子
code = 0300 / message = There is no information for accept_id(None), about the your site id(指定した識別子)
</pre></div>
</div>
</li>
<li><p>異常な場合その１：識別子の間違い</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">code</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">/</span> <span class="n">message</span> <span class="o">=</span> <span class="n">Your</span> <span class="n">site</span><span class="o">-</span><span class="nb">id</span><span class="p">(</span><span class="n">指定した識別子</span><span class="p">)</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">that</span> <span class="n">acceptable</span> <span class="n">to</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>異常な場合その２：APIトークン間違い</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2022</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">19</span> <span class="mi">17</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="n">status</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">403</span> <span class="o">/</span> <span class="n">reason</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;errors&quot;</span><span class="p">:[{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;0005&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;/mi-distcomp-api/calc-requestへの実行権がありません。&quot;</span><span class="p">}]}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>終了方法</p>
<ul>
<li><p>CtrlキーとCキーを同時に押します。以下の様に表示され最大６０秒後に終了します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ctrl</span> <span class="o">+</span> <span class="n">C</span> <span class="n">スクリプト停止要求受付</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>この作業はWebAPI方式を選択した場合に必要です。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>WebAPIを実行するユーザーでの作業となります。</p>
</div>
</div>
<div class="section" id="mint">
<h3><span class="section-number">4.8.2. </span>MIntシステム認証プログラム<a class="headerlink" href="#mint" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>本資材はWebAPI方式を選択し、WebAPIポーリングプログラムをAPIトークンを利用せず、通常のログイン・パスワード方式で実行する場合に必要です。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>この方式ですとコマンドラインにAPIトークンを記述する必要がなく、安全性もたかい使用法となります。インストールはroot権限で行います。必要な場合はMIntシステム運用チームまでご相談ください。</p>
</div>
</div>
<div class="section" id="id30">
<h3><span class="section-number">4.8.3. </span>SSH用利用者側実行スクリプト集<a class="headerlink" href="#id30" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH方式を選択した場合に必要になります。手順は公開している場所から以下の要領でgitコマンドを使用してダウンロード、展開します。</p>
<ul>
<li><p>手順</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd &lt;展開したい場所&gt;
$ git clone https://github.com/materialsintegration/remote_workflow.git
</pre></div>
</div>
</li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="whatisrepository"><span class="brackets"><a class="fn-backref" href="#id26">5</a></span></dt>
<dd><p>本機能を実現する資材などを格納したサーバ。GitHubを利用しているが、アカウントが無くともダウンロードは可能である。MInt運用チームがアカウントを発行したユーザのみアップロードが可能である。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="id31">
<h1><span class="section-number">5. </span>利用方法<a class="headerlink" href="#id31" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id32">
<h2><span class="section-number">5.1. </span>SSH方式<a class="headerlink" href="#id32" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>主に、外部計算機資源側の利用方法について記述する。</p>
<ol class="arabic">
<li><p><strong>misrc_remote_workflow</strong> リポジトリを展開した場所の通知</p>
<blockquote>
<div><ul class="simple">
<li><p>この場所をMIntシステム運用チームへ知らせる。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>外部計算機側で実行するスクリプトがあれば <strong>remote-side_scripts</strong> に配置する。</p></li>
<li><p>MIntが外部計算機へログインして最初に実行するプログラム名は前述のとおり <strong>execute_remote-side_program_ssh.sh</strong> に固定されている。このため <strong>execute_remote-side_program_ssh.sample.sh</strong> をこの名前でコピーするか、新規に作成して、必要な手順をスクリプト化する。</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>SSH方式の場合は外部計算機において待機する必要のあるプログラムなどは無い。</p>
</div>
<div class="section" id="id33">
<h3><span class="section-number">5.1.1. </span>(参考)MInt側作業<a class="headerlink" href="#id33" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>外部計算資源を利用するモジュールが実行可能なスクリプト <strong>misrc_remote_workflow/scripts/execute_remote_command.sample.sh</strong> をコピーして専用スクリプトを作成する。</p></li>
<li><p>予測モジュールのmodules/resouceRequest/pbsNodeGroupタグに ssh-node01 という値をセットする。</p></li>
<li><p>予測モジュールのmodules/objectPathタグに1. で作成したスクリプトをセットする。</p></li>
<li><p>1.で作成したスクリプトを各行のコメントに従い適宜修正する。</p></li>
<li><p>1.を実行可能な予測モジュールを組み込んだワークフローを作成する。</p></li>
</ol>
</div>
</div>
<div class="section" id="id34">
<h2><span class="section-number">5.2. </span>WebAPI方式<a class="headerlink" href="#id34" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>主に、外部計算機資源側の準備について記述する。</p>
<ol class="arabic simple">
<li><p><strong>misrc_distributed_computing_assist_api</strong> リポジトリを展開する。</p></li>
<li><p><strong>authentication_operator</strong> リポジトリを展開、環境変数を設定する。（ログイン方式を選択する場合）</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>環境変数AUTHENTICATION_OPERATORはログインシェルの自動設定ファイルに設定しておく。</p>
</div>
<ol class="arabic simple" start="3">
<li><p>計算に必要なスクリプトの準備</p>
<ul class="simple">
<li><p>独自に実行ファイルを用意した場合はの情報はMInt運用チームに伝えておく。</p></li>
<li><p>特別なリポジトリを利用する場合はこの作業が必要ないこともある。</p></li>
</ul>
</li>
</ol>
<div class="section" id="id35">
<h3><span class="section-number">5.2.1. </span>実行<a class="headerlink" href="#id35" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>認証情報と共にポーリングプログラムを動作させておく。事前に設定した情報に従ってMIntシステム側と通信し、入力ファイルの受信、計算、出力ファイルの送信が自動的に行われる。認証情報が無い、間違っている、などの場合はポーリングは失敗し、計算は行われない。
また <strong>ワークフローを実行したユーザーと同じユーザーのトークンまたはログイン方式での同じユーザー</strong> で実行しないとこちらもポーリングは失敗し、計算は行われない。</p>
<ol class="arabic">
<li><dl class="field-list simple">
<dt class="field-odd">numref</dt>
<dd class="field-odd"><p><cite>api_polling_program</cite> :ref: <cite>api_polling_program</cite> の動作確認で実行したどちからの方法で、<strong>mi-system-remote.py</strong> を実行する。</p>
</dd>
</dl>
</li>
<li><p>終了する場合はCtrl+Cで停止する。</p>
<blockquote>
<div><ul class="simple">
<li><p>ポーリング中の処理がある場合に備えてすぐには終了しない。</p></li>
<li><p>処理中の情報が無ければ最大60秒で終了する。</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id36">
<h3><span class="section-number">5.2.2. </span>(参考)MInt側作業<a class="headerlink" href="#id36" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>misrc_distributed_computing_assist_api</strong> リポジトリを展開する。</p></li>
<li><p>構成ファイル <strong>mi_distributed_computing_assist.ini</strong> に必要な設定を行う。</p></li>
<li><p><strong>mi_dicomapi.py</strong> を動作させて待ち受け状態にする。</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python mi_dicomapi.py
</pre></div>
</div>
<p>または</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ systemctl start distcomp_api
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>モジュールの実行プログラム内で、<strong>misrc_distributed_computing_assist_api/debug/mi-system-side/mi-system-wf.py</strong> を必要なパラメータとともに実行するように構成する。</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>ワークフロー側から計算登録時に構成ファイルは再読込されるので、WebAPIプログラムが現在動作中であっても読み込ませるための特別な動作は必要ない。</p>
</div>
</div>
</div>
<div class="section" id="sample">
<span id="id37"></span><h2><span class="section-number">5.3. </span>外部計算機の作業場所<a class="headerlink" href="#sample" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>SSH方式、WebAPI方式のどちらも計算場所はワーキングディレクトリ <a class="footnote-reference brackets" href="#whatisworkingdirectory" id="id38">6</a> と言い、UUIDで構成されたディレクトリ名のディレクトリの作成時間などで該当ディレクトリかどうか判断する。</p>
<dl class="footnote brackets">
<dt class="label" id="whatisworkingdirectory"><span class="brackets"><a class="fn-backref" href="#id38">6</a></span></dt>
<dd><p>外部計算機側のワーキングディレクトリは/tmpディレクトリに作成されるので、OSの設定に変更がなければ30日後に削除される。このため問題が発生した場合は発生から30日以内に調査を開始する必要がある。</p>
</dd>
</dl>
</div>
<div class="section" id="id39">
<h2><span class="section-number">5.4. </span>その他MInt側注意事項<a class="headerlink" href="#id39" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>SSH方式、WebAPI方式共通の注意事項など。</p>
<ul class="simple">
<li><p>pbsNodeGroup設定でssh-node01を設定する。他の計算機では外へアクセスすることができないため。</p></li>
<li><p>pbsQueueなどCPU数などは指定できない。</p></li>
<li><p>外部計算機側で別途Torqueなどのバッチジョブシステムに依存する。</p></li>
</ul>
</div>
<div class="section" id="id40">
<h2><span class="section-number">5.5. </span>エラーが発生した場合<a class="headerlink" href="#id40" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ワークフローを本実行する前にMInt運用チームと連携して動作確認を行っておくが、予期せず異常終了した場合などは以下の方法で対策を検討することができる。</p>
<ul class="simple">
<li><p>SSH方式、WebAPI方式ともワークフローの出力ポートとは別に外部計算機で計算が行われた際の処理のログがある。MInt運用チームに連絡して、それを入手する。</p></li>
<li><p>WebAPI方式であれば通信ログがポーリングプログラムの実行画面に出力されるのでこれを利用する。</p></li>
<li><p>同様に、外部計算機のワーキングディレクトリに計算結果およびログが残っているのでこれを利用する。</p></li>
</ul>
<div class="section" id="id41">
<h3><span class="section-number">5.5.1. </span>通信異常<a class="headerlink" href="#id41" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>インターネット経由であるので、通信異常は発生するものとして対処してある。WebAPI方式では外部計算機側からの通信となるため、外部計算機側のプログラムでリトライ方式を採用している。デフォルトはリトライ間隔60秒のリトライ回数5回で通信失敗として終了する。この値は以下の書式で上書き指定することも可能である。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python mi-system-remote.py &lt;ホスト情報&gt; https://nims.mintsys.jp &lt;API token&gt; retry:&lt;リトライ回数&gt;,&lt;リトライ間隔&gt;
</pre></div>
</div>
<p>SSH方式ではその性質上処理中に通信異常が起きると復帰できない。現バージョンではSSH方式での処理中の通信異常を復帰させる手段は実装されていない。どちらの場合も通信が途絶えて処理続行不能と判断されれば、MIntシステム側に異常を通知し、異常終了となる ように構成されている。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>リトライ回数は整数で指定し、リトライ間隔は整数または実数で指定する。</p>
</div>
</div>
</div>
<div class="section" id="id42">
<h2><span class="section-number">5.6. </span>ワークフローの廃止<a class="headerlink" href="#id42" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ユーザがMInt運用チームにワークフローの廃止届を提出する。当該ワークフローはMInt上で「無効」のステータスを付与され参照・実行不能となる。</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<p>以上</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">外部計算資源の利用について</a></h1>








<h3>ナビゲーション</h3>
<p class="caption"><span class="caption-text">目次:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. はじめに</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">1.1. 本書の対象</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">1.1.1. 対象読者</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">1.1.2. 対象範囲</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id5">2. 概要</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id6">2.1. 利用イメージ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sshwebapi">2.2. SSH方式とWebAPI方式の比較</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id9">3. 動作原理</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ssh">3.1. SSH方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.1.1. 動作イメージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3.1.2. ワークフロー例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.1.3. モジュール内の処理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#webapi">3.2. WebAPI方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">3.2.1. 動作イメージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">3.2.2. ワークフロー例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">3.2.3. モジュール内の処理</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-to-use">4. 利用のための準備</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#before-descide-items">4.1. 事前確認</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id20">4.2. 利用申請</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id21">4.2.1. 公開鍵の用意</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api">4.2.2. APIトークンの用意</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id22">4.3. 環境構築</a></li>
<li class="toctree-l2"><a class="reference internal" href="#os">4.4. OSの準備</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ready-public-keys">4.5. ソルバーの準備</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python">4.6. Pythonの準備</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id24">4.6.1. バージョン確認</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">4.6.2. 追加のパッケージ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#git">4.7. gitの準備</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id27">4.7.1. 確認方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id28">4.8. 外部計算機資源を利用するため資材</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api-polling-program">4.8.1. WebAPI用ポーリングプログラム</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mint">4.8.2. MIntシステム認証プログラム</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id30">4.8.3. SSH用利用者側実行スクリプト集</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id31">5. 利用方法</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id32">5.1. SSH方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id33">5.1.1. (参考)MInt側作業</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id34">5.2. WebAPI方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id35">5.2.1. 実行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">5.2.2. (参考)MInt側作業</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sample">5.3. 外部計算機の作業場所</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id39">5.4. その他MInt側注意事項</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id40">5.5. エラーが発生した場合</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id41">5.5.1. 通信異常</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id42">5.6. ワークフローの廃止</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="前の章へ">外部計算資源の利用方法（本運用）</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, SIP-MI.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/using_distributed_properties.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>