
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>1. はじめに &#8212; 外部計算資源の利用について 0.2.0 ドキュメント</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="prev" title="外部計算資源の利用方法（本運用）" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1><span class="section-number">1. </span>はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>MIntには、ワークフローを構成するモジュール内の一部分の処理を、MIntの計算ノード以外の「外部計算機」に行わせる機能がある。本機能によって、ユーザには下記に挙げる利点がある。</p>
<ul class="simple">
<li><p>部外秘プログラムの使用</p></li>
<li><p>部外秘データの使用</p></li>
<li><p>特殊構成 (MIntの計算ノードでは対応できない) の計算機を使用できる</p></li>
<li><p>商用ソフトの使用 (MIntの計算ノードにも商用ソフトがインストールされているが、ライセンスの規定上、ほとんどの場合NIMS外からは利用できない)</p></li>
</ul>
<p>外部計算資源の利用に際しては、MInt、外部計算機の双方が後述のセキュリティ水準を満たす必要がある。</p>
<ol class="arabic">
<li><p>MIコンソーシアム会則（機密保持誓約書含む）、MIntシステム利用規定など、MInt利用に関わる契約・規定を遵守すること。</p></li>
<li><p>MInt側は、下記のセキュリティ対策を実施すること。</p>
<blockquote>
<div><ul class="simple">
<li><p>第三者によるMIntのセキュリティ分析・セキュリティリスク診断を実施し、リスクを避ける設計を維持すること。</p></li>
<li><p>MIntを構成するサーバのOS・ミドルウェア・ライブラリ等に対し、継続的に脆弱性データベースを確認し、必要なアップデートを実施すること。</p></li>
<li><p>不正アクセス監視やネットワーク負荷監視を実施すること。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>外部計算機側は、外部計算機として利用されるコンピュータに対し、十分なセキュリティ対策を実施すること。継続的に利用する場合には、定期的に対策状況を確認し、セキュリティレベルを維持すること。</p></li>
</ol>
<p>外部計算資源利用には、SSH方式とWebAPI方式がある。
前者はMIntから外部計算機へSSHで必要なデータとコマンドをプッシュする方式である。
単純で、外部計算を遅延なく開始できる利点があるが、外部計算機側でMIntに対しSSHのポートを開放してプッシュを受け入れる必要がある点は、特に企業ユーザではハードルが高いことが想定される。
これに対し、後者は数分間隔で外部計算機側からMIntにWebAPI(https)でポーリングし、処理すべき案件が存在した場合は、必要なデータとコマンドがプルされる方式である。
この方式では外部計算機側にポート開放の必要が無いが、外部計算の開始までにポーリング間隔に相当する遅延が生じる。</p>
<p>本機能は外部計算機内にユーザが持つ秘匿データの扱いにも十分な配慮が行われている。
まず、ユーザが持つ秘匿データMIntが収集する情報はワークフローの各モジュールの入出力ポートの情報のみであるため、モジュールの内部で完結する本機能のために、モジュールと外部計算機の間で送受信される情報は収集対象外である。
外部計算機側は、MIntにあらかじめ定められたコマンドのみ実行できるように設定することができる。
また、MIntに処理結果を返送する前に不必要なデータをワーキングディレクトリから削除することができる。</p>
<p>上記の機構によって、安全な外部計算が保証される。下記の各章で具体的な利用方法について記す。
また、外部計算資源の利用に際して本書では不明な点は、ユーザとMInt運用チームとの協議で決定するものとする。</p>
</div>
<div class="section" id="id2">
<h1><span class="section-number">2. </span>概要<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id3">
<h2><span class="section-number">2.1. </span>利用イメージ<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>外部計算資源の利用イメージを( <a class="reference internal" href="#image-for-use-eps"><span class="std std-numref">図 2.1</span></a> )に示す。</p>
<ul class="simple">
<li><p>MIntはNIMS構内のDMZ <a class="footnote-reference brackets" href="#whatisdmz" id="id4">1</a> に存在する。</p></li>
<li><p>ユーザはMInt上に、外部計算を利用するモジュールを含んだワークフローを持つ。当該モジュールやワークフローの参照・実行権限は自機関内などに限定できる。</p></li>
<li><p>ユーザが当該ワークフローを実行すると、外部計算を利用するモジュールで一部の処理が外部計算機に受け渡される。</p></li>
<li><p>外部計算機は処理の過程で、MIntに置けないデータやプログラムにアクセスできる。これらのアクセスを外部計算機の内部で完結させることで、安全な利用が可能となる。</p></li>
</ul>
 <A HREF="_images/remote_execution_image.png"><img src="_images/remote_execution_image.png" /></A>

外部計算資源の利用イメージ<div class="figure align-center" id="image-for-use-eps">
<a class="reference internal image-reference" href="_images/image_for_use.eps"><img alt="_images/image_for_use.eps" src="_images/image_for_use.eps" style="width: 385.8px; height: 221.4px;" /></a>
<p class="caption"><span class="caption-number">図 2.1 </span><span class="caption-text">外部計算資源の利用イメージ</span><a class="headerlink" href="#image-for-use-eps" title="この画像へのパーマリンク">¶</a></p>
</div>
<dl class="footnote brackets">
<dt class="label" id="whatisdmz"><span class="brackets"><a class="fn-backref" href="#id4">1</a></span></dt>
<dd><p>物理的にはNIMS構内のサーバ室に存在するが、ネットワーク的には機構内LANとインターネットの双方からファイアウォールで切り離された領域。</p>
</dd>
</dl>
</div>
<div class="section" id="sshwebapi">
<h2><span class="section-number">2.2. </span>SSH方式とWebAPI方式の比較<a class="headerlink" href="#sshwebapi" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>SSH方式</dt><dd><ul>
<li><p>MIntからSSHで外部計算機にアクセスし、必要なファイルとコマンドをプッシュし、コマンドを発行し、結果を得る。</p></li>
<li><p>ファイルは内部でrsync -avを利用して送受信され、サイズは無制限である。</p></li>
<li><p>コマンドラインなどの文字列はBase64エンコード無しで送受信される。</p></li>
<li><p>外部計算機側SSHサーバのポート(TCP/22以外でも可)のインバウンドアクセスの開放が必要である。</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>WebAPI方式</dt><dd><ul>
<li><p>外部計算機からMIntのAPIサーバにポーリングを行い、要処理案件の有無を確認する。ポーリング間隔は数分程度を想定している。案件があれば必要なデータとコマンドをプルし、自らコマンドを実行し、APIで結果を送信する。</p></li>
<li><p>ファイルはBase64エンコードされ、サイズはエンコード後に2GiB未満である必要がある。</p></li>
<li><p>コマンドラインなどの文字列はBase64エンコード無しで送受信される。</p></li>
<li><p>MIntのAPIサーバへのhttps(TCP/443)のアウトバウンドアクセスの許可が必要である。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h1><span class="section-number">3. </span>動作原理<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="ssh">
<h2><span class="section-number">3.1. </span>SSH方式<a class="headerlink" href="#ssh" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id6">
<h3><span class="section-number">3.1.1. </span>動作イメージ<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH 方式での外部資源利用のイメージを( <a class="reference internal" href="#ssh-project-create-flow"><span class="std std-numref">図 3.1</span></a> )に示す。</p>
<div class="figure align-center" id="id28">
<span id="ssh-project-create-flow"></span>
            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <script>mermaid.initialize({startOnLoad:true});</script><div class="mermaid">
            graph LR;

subgraph NIMS所外
  input3[\秘匿データ/]
  module21[専用プログラム実行]
  module22[データ返却]
end
subgraph MInt
  subgraph ワークフロー
    input1[\入力/]
    module11[SSH実行開始]
    module12[SSHデータ受け取り]
    module13[計算]
    output1[/出力\]
  end
end

input1--&gt;module11
module11--&gt;module12
module12--&gt;module13
module13--&gt;output1
input3--&gt;module21
module11--SSH経由--&gt;module21
module21--&gt;module22
module22--SSH経由--&gt;module12
        </div><p class="caption"><span class="caption-number">図 3.1 </span><span class="caption-text">SSH方式の外部資源利用のイメージ</span><a class="headerlink" href="#id28" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id7">
<h3><span class="section-number">3.1.2. </span>ワークフロー例<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SSH方式の外部資源利用を含むワークフローを、MIntのワークフローデザイナで表示した例を示す。
赤枠の部分が遠隔実行の行われるモジュールである。
なお、本ワークフローは動作検証用サンプルとして、<a class="reference internal" href="#how-to-use"><span class="std std-ref">使用方法</span></a> で説明するインストール資材に含まれている。</p>
<div class="figure align-center" id="id29">
<a class="reference internal image-reference" href="_images/workflow_with_sshmodule.png"><img alt="_images/workflow_with_sshmodule.png" src="_images/workflow_with_sshmodule.png" style="width: 796.0px; height: 441.6px;" /></a>
<p class="caption"><span class="caption-number">図 3.2 </span><span class="caption-text">動作検証用のワークフロー</span><a class="headerlink" href="#id29" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id8">
<h3><span class="section-number">3.1.3. </span>モジュール内の処理<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>外部資源利用を行うモジュール内で、外部計算機側の処理が実行されるまでの流れを下記に示す。</p>
<div class="figure align-center" id="id30">

            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

  participant A as モジュール
  participant B as プログラム（Ａ）
  participant C as プログラム（Ｂ）
  participant D as プログラム（Ｃ）
  participant E as プログラム（Ｄ）

  Note over A,C : MInt内
  Note over D,E : 外部計算機内

  A-&gt;&gt;B:モジュールが実行
  B-&gt;&gt;C:（Ａ）が実行
  C-&gt;&gt;D:（Ｂ）がSSH経由で外部計算機の（Ｃ）を実行
  D-&gt;&gt;E:（Ｃ）が実行
        </div><p class="caption"><span class="caption-number">図 3.3 </span><span class="caption-text">SSH接続経由によるコマンド実行の流れ</span><a class="headerlink" href="#id30" title="この画像へのパーマリンク">¶</a></p>
</div>
<ul>
<li><p>モジュール</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのワークフローシステムによって実行されるモジュール</p></li>
<li><p>プログラム（Ａ）を実行する</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ａ）</p>
<blockquote>
<div><ul class="simple">
<li><p>モジュールによって実行されるプログラム</p></li>
<li><p>モジュール固有の前処理を行う。</p></li>
<li><p>モジュールごとに任意の名前で用意する。</p></li>
<li><p><a class="reference internal" href="#how-to-use"><span class="std std-ref">使用方法</span></a> で説明する編集を行う。</p></li>
<li><p>（Ｂ）を実行する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｂ） このプログラムが外部計算機と通信を行う。</p>
<blockquote>
<div><ul>
<li><p>外部計算の準備を行う。</p></li>
<li><p>名前は「execute_remote_command.sh」固定である。(インストール資材に含まれるサンプルファイルはリネームが必要)</p></li>
<li><p><a class="reference internal" href="#how-to-use"><span class="std std-ref">使用方法</span></a> で説明する編集を行う。</p></li>
<li><p>SSH経由で（Ｃ）を実行する。</p>
<blockquote>
<div><ul class="simple">
<li><p>送信するファイルはパラメータとして記述する。</p></li>
<li><p>外部計算機上の一時ディレクトリ <a class="footnote-reference brackets" href="#calc-dir1" id="id9">2</a> の内容を全部受信するため、MIntに送信しないデータは外部計算機側で（Ｃ）の実行終了前に削除する。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｃ）</p>
<blockquote>
<div><ul class="simple">
<li><p>名前は「execute_remote-side_program_ssh.sh」固定である。(インストール資材に含まれるサンプルファイルはリネームが必要)</p></li>
<li><p>外部計算機上で実行するプログラムは、ここへシェルスクリプトとして記述する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｄ）</p>
<blockquote>
<div><ul class="simple">
<li><p>必要に応じて（Ｃ）から実行される外部計算用スクリプト群。</p></li>
<li><p>外部計算機上のプログラムを（Ｃ）のみで完結させ、本スクリプト群は用意しない運用も可。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="calc-dir1"><span class="brackets"><a class="fn-backref" href="#id9">2</a></span></dt>
<dd><p>外部計算機では、処理は/tmpなどに作成した一時ディレクトリで実行される。</p>
</dd>
<dt class="label" id="sample-name1"><span class="brackets">3</span></dt>
<dd><p>本システムでは、MIntは「execute_remote_command.sample.sh」を実行し、外部計算機で実行するプログラムとして「execute_remote-side_program_ssh.sh」を呼び出す。外部計算機側ではインストール後にこのファイル（インストール直後は、execute_remote_program_ssh.sample.shと言う名前）を必要に応じて編集して使用することで、別なコマンドを記述することが可能になっている。</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="webapi">
<h2><span class="section-number">3.2. </span>WebAPI方式<a class="headerlink" href="#webapi" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id10">
<h3><span class="section-number">3.2.1. </span>動作イメージ<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPI方式での外部計算の実行イメージを( <a class="reference internal" href="#id11"><span class="std std-numref">図 3.4</span></a> )に示す。</p>
<div class="figure align-center" id="id31">
<span id="id11"></span>
            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

participant A as MInt&lt;BR&gt;
participant B as MInt WebAPIサーバ&lt;BR&gt;
participant C as WebAPI方式&lt;BR&gt;（外部計算機側）
participant D as ユーザープログラム&lt;BR&gt;（外部計算機側）


C-&gt;&gt;B:リクエスト
  alt 計算が存在しない
    B-&gt;&gt;C:ありません
    C --&gt;&gt; C:リクエスト継続
  else 計算が存在する
    A-&gt;&gt;B:計算要求
    C-&gt;&gt;B:リクエスト
    B-&gt;&gt;C:存在する
    C-&gt;&gt;B:情報取得リクエスト
    alt 計算実行
      B-&gt;&gt;C:パラメータ送付、コマンドライン送付
      C-&gt;&gt;D:プログラム実行
      alt プログラム実行
        D --&gt;&gt; D:プログラム実行中
      else プログラム終了
        D --&gt;&gt; C:プログラム終了
      end
      C-&gt;&gt;B:計算終了通知
    else no seq
    end
    B-&gt;&gt;C:計算結果の返却要求
    C-&gt;&gt;B:計算結果の返却応答
    B-&gt;&gt;A:ジョブの終了要求
  end
        </div><p class="caption"><span class="caption-number">図 3.4 </span><span class="caption-text">WebAPI方式の流れ</span><a class="headerlink" href="#id31" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id12">
<h3><span class="section-number">3.2.2. </span>ワークフロー例<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>WebAPI方式の外部資源利用を含むワークフローを、MIntのワークフローデザイナで表示した例を示す。
赤枠の部分が遠隔実行の行われるモジュールである。
なお、本ワークフローは動作検証用サンプルとして、<a class="reference internal" href="#how-to-use"><span class="std std-ref">使用方法</span></a> で説明するインストール資材に含まれている。</p>
<div class="figure align-center" id="id32">
<a class="reference internal image-reference" href="_images/workflow_with_apimodule.png"><img alt="_images/workflow_with_apimodule.png" src="_images/workflow_with_apimodule.png" style="width: 965.0px; height: 519.0px;" /></a>
<p class="caption"><span class="caption-number">図 3.5 </span><span class="caption-text">検証用ワークフロー</span><a class="headerlink" href="#id32" title="この画像へのパーマリンク">¶</a></p>
</div>
<p>※赤枠の部分が外部計算資源を利用するモジュールである。</p>
</div>
<div class="section" id="id13">
<h3><span class="section-number">3.2.3. </span>モジュール内の処理<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ワークフローの当該モジュール内で外部計算機側の処理が実行されるまでの流れを下記に示す。</p>
<div class="figure align-center" id="id33">

            <style>
            /* mermaid issue 527 workaround */
            .section {
                opacity: 1.0 !important;
            }
            </style>
            <div class="mermaid">
            sequenceDiagram;

  participant A as モジュール
  participant B as プログラム（Ａ）
  participant C as WebAPI
  participant D as プログラム（Ｃ）
  participant E as プログラム（Ｄ）

  Note over A,C : MInt内
  Note over D,E : 外部計算機内

  A-&gt;&gt;B:モジュールが実行
  B-&gt;&gt;C:（Ａ）がhttps経由でAPI発行
  D-&gt;&gt;C:（Ｃ）がhttps経由でAPI発行
  D-&gt;&gt;E:（Ｃ）が実行
        </div><p class="caption"><span class="caption-number">図 3.6 </span><span class="caption-text">WebAPI方式でのコマンドの流れ</span><a class="headerlink" href="#id33" title="この画像へのパーマリンク">¶</a></p>
</div>
<ul>
<li><p>モジュール</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのワークフローシステムによって実行されるモジュール</p></li>
<li><p>プログラム（Ａ）を実行する</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ａ）</p>
<blockquote>
<div><ul class="simple">
<li><p>モジュールによって実行されるプログラム</p></li>
<li><p>モジュール固有の前処理を行う。</p></li>
<li><p>モジュールごとに任意の名前で用意する。</p></li>
<li><p>misrc_distributed_computing_assist_api/debug/mi-system-side/mi-system-wf.pyを実行しておく。</p></li>
<li><p>WebAPIへ計算の情報を登録する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>WebAPI (このプログラムがMIntシステムと外部計算機との通信を中継する。)</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>外部計算の準備を行う。</dt><dd><ul>
<li><p>送受信するファイルはパラメータとしてあらかじめ設定しておく。</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>WebAPI経由で（Ｃ）からのアクセスを受け付ける</p></li>
<li><p>（Ａ）から計算の情報登録が無い限り、（Ｃ）からアクセスがあっても計算は始まらない。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｃ）</p>
<blockquote>
<div><ul class="simple">
<li><p>ポーリングプログラムである。</p></li>
<li><p>misrc_distributed_computing_assist_api/debug/remote-side/mi-system-remote.pyを実行しておく。</p></li>
<li><p>外部計算機上で実行するプログラム名は、このプログラム経由でMIntシステムから受信され、このプログラムが実行する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>プログラム（Ｄ）</p>
<blockquote>
<div><ul class="simple">
<li><p>（Ｃ）から実行される外部計算用スクリプト。</p></li>
<li><p>名前は任意。（プログラム（Ｃ）経由で伝えられるため、あらかじめMIntシステム側に設定が必要）</p></li>
<li><p>「execute_remote_command_api.sh」を参考にして作成しておく。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="id14"></span><h1><span class="section-number">4. </span>使用方法<a class="headerlink" href="#how-to-use" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>SSH方式、WebAPI方式それぞれのインストールおよびプログラムの実行までを説明する。
なお、外部計算機はbashスクリプトとPythonスクリプトの動作するLinuxホストを想定しているが、MInt側の通信が正常に確立できるならば、これ以外の環境でも構わない。
また、外部計算機側で秘匿データを扱う際は、これに関する仕様をMInt側に開示する必要も無い。</p>
<div class="section" id="before-descide-items">
<span id="id15"></span><h2><span class="section-number">4.1. </span>事前決定事項<a class="headerlink" href="#before-descide-items" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>事前に決定しておく項目は以下の通り。</p>
<ol class="arabic">
<li><p>環境構築</p>
<blockquote>
<div><ul class="simple">
<li><p>外部計算機側, MInt側のユーザアカウントの準備</p></li>
<li><p>SSH or WebAPIの方式選択</p></li>
<li><p>認証関連情報の準備</p></li>
</ul>
</div></blockquote>
</li>
<li><p>ワークフロー・モジュールの仕様策定 (実装調査書の作成)</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntと外部計算機の役割分担の決定</p></li>
<li><p>MIntと外部計算機の間を受け渡すパラメータ・ファイルの設計</p></li>
<li><p>MInt側の前処理・後処理の設計</p></li>
<li><p>外部計算機側スクリプトの設計</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="ssh-webapi">
<h2><span class="section-number">4.2. </span>SSH, WebAPI方式共通<a class="headerlink" href="#ssh-webapi" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id16">
<h3><span class="section-number">4.2.1. </span>資材の入手<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>外部計算資源の利用に必要な資材は GitHub 上のリポジトリ <a class="footnote-reference brackets" href="#whatisrepository" id="id17">4</a> <a class="reference external" href="https://github.com/materialsintegration">https://github.com/materialsintegration</a> に用意されている。</p>
<ul>
<li><p>misrc_remote_workflow</p>
<blockquote>
<div><ul class="simple">
<li><p>主に外部計算機側で実行されるスクリプトのサンプルが同梱されている。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>misrc_distributed_computing_assist.api</p>
<blockquote>
<div><ul class="simple">
<li><p>WebAPI方式用のプログラムおよびサンプルが同梱されている。</p></li>
<li><p>MInt側資材は「debug/mi-system-side」、外部計算機側資材は「debug/remote-side」にある。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<dl class="footnote brackets">
<dt class="label" id="whatisrepository"><span class="brackets"><a class="fn-backref" href="#id17">4</a></span></dt>
<dd><p>本機能を実現する資材などを格納したサーバ。GitHubを利用しているが、MInt運用チームがアカウントを発行したユーザのみダウンロードが可能である。</p>
</dd>
</dl>
<p>ユーザは外部計算機上にこれらを展開し、必要なカスタマイズを行う。
資材展開後の外部計算機側のディレクトリ構造は以下のようになる。</p>
<ul class="simple">
<li><p>ユーザーディレクトリ</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/ユーザーディレクトリ
  + remote_workflow
    + scripts
      + input_data
  + misrc_distributed_computing_assist_api
    + debug
      + remote-side
</pre></div>
</div>
<ul class="simple">
<li><p>ワーキングディレクトリ</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/tmp/&lt;uuid&gt;
</pre></div>
</div>
<p>ユーザが外部計算機側でカスタマイズするファイルは、通常、SSH方式では「misrc_remote_workflow/scripts/execute_remote-side_program_ssh.sample.sh」、WebAPI方式では「execute_remote-side_program_api.sample.sh」のみである。カスタマイズの方法については後述する。
これ以外のファイルも改変可能であるが、その改変が原因で外部計算を利用するワークフローが動作しなかった場合、MInt運用チームは責を負わない。</p>
<p>資材展開後のMInt側のディレクトリ構造は以下のようになる。</p>
<ul class="simple">
<li><p>ユーザーディレクトリ</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/misystemディレクトリ
 + remote_workflow
   + scripts
 + misrc_distributed_computing_assist_api
   + debug
     + mi-system-side
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>ワーキングディレクトリ</dt><dd><ul>
<li><p>複雑なので省略する。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id18">
<h3><span class="section-number">4.2.2. </span>ワークフローサンプル<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>misrc_remote_workflow/sample_dataに、Abaqus実行環境が用意可能な場合に使用可能なワークフローおよび、そのサンプル入力ファイルが用意されている。
これを利用して、MInt側と外部計算機側のテストが可能である。
また、misrc_remote_workflow/scriptsに、この時のモジュール実行プログラムがある。
これを参考に、他のモジュール実行プログラムを作成することが可能である。
利用する際にはMIntシステム側と調整が必要である。</p>
<ul class="simple">
<li><p>kousoku_abaqus_ssh_version2.py : SSH方式のモジュール実行スクリプト</p></li>
<li><p>kousoku_abaqus_api_version2.py : WebAPI方式のモジュール実行スクリプト</p></li>
</ul>
<p>もっと簡易な例題ワークフローは現在準備中である。</p>
</div>
</div>
<div class="section" id="id19">
<h2><span class="section-number">4.3. </span>SSH方式<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id20">
<h3><span class="section-number">4.3.1. </span>公開鍵の用意<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>パスフレーズ無しの公開鍵認証を原則とする。
外部計算機側で作成したRSA公開鍵 (例: ~/.ssh/id_rsa.pub) をMInt運用チームに送付する。
鍵は既存のものでも良いが、下記のコマンドで新規に作成しても良い。</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/misystem/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/misystem/.ssh/id_test_rsa.
Your public key has been saved in /home/misystem/.ssh/id_test_rsa.pub.
The key fingerprint is:
fd:f6:ab:3c:55:8d:f5:4d:52:60:27:2b:9b:b8:49:fb misystem@zabbix-server
The key&#39;s randomart image is:
+--[ RSA 2048]----+
|              +oo|
|             ..+o|
|            . .=+|
|         . . +. =|
|        S + o  . |
|         . =  .  |
|          + o.   |
|           +..   |
|            Eoo. |
+-----------------+
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id21">
<h3><span class="section-number">4.3.2. </span>資材の展開<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>misrc_remote_workflowリポジトリを展開する。</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://gitlab.mintsys.jp/midev/misrc_remote_workflow
$ cd misrc_remote_workflow
$ ls
README.md  documents  inventories  misrc_remote_workflow.json  modulesxml  sample_data  scripts
$ cd scripts
$ ls
abaqus                                     execute_remote_command.sample.sh  kousoku_abaqus_ssh.sh
create_inputdata.py                        input_data                        kousoku_abaqus_ssh_version2.py
execute_remote-side_program_api.sample.sh  kousoku_abaqus_api_version2.py    kousoku_abaqus_ssh_version2.sh
execute_remote-side_program_ssh.sample.sh  kousoku_abaqus_api_version2.sh    remote-side_scripts
execute_remote_command.sample.py           kousoku_abaqus_http.py
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>外部計算機側で実行するスクリプトがあれば「remote-side_scripts」に配置する。</p></li>
<li><p>MIntが外部計算機へログインして最初に実行するプログラム名は前述のとおり「execute_remote-side_program_ssh.sh」に固定されている。このため「execute_remote-side_program_ssh.sample.sh」をこの名前でコピーするか、新規に作成して、必要な手順をスクリプト化する。</p></li>
</ol>
</div>
<div class="section" id="mint">
<h3><span class="section-number">4.3.3. </span>(参考)MInt側作業<a class="headerlink" href="#mint" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>外部計算資源を利用するモジュールが「misrc_remote_workflow/scripts/execute_remote_command.sample.sh」に相当するスクリプト(実際にはリネームされている)が必要なパラメータとともに実行するように構成する。</p></li>
<li><p>1.を実行可能なワークフローを、外部計算を含まないものと同じ手順で作成する。</p></li>
</ol>
</div>
</div>
<div class="section" id="id22">
<h2><span class="section-number">4.4. </span>WebAPI方式<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id23">
<h3><span class="section-number">4.4.1. </span>認証関連情報の用意<a class="headerlink" href="#id23" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>MInt側担当者に問い合わせて下記の情報を用意する。</p>
<ul>
<li><p>ホスト情報</p>
<blockquote>
<div><ul class="simple">
<li><p>MInt側でAPIの発行者を識別するための文字列。ユーザ企業のドメインなどと一致させる必要は無い。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>APIトークン</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのAPI認証システムを使用するためのトークン。MInt運用チームに問い合わせて取得する。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>MIntのURL</p>
<blockquote>
<div><ul class="simple">
<li><p>MIntのURL(エンドポイントは不要)を、MInt運用チームに問い合わせておく。</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id24">
<h3><span class="section-number">4.4.2. </span>資材の展開<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>misrc_distributed_computing_assist_apiリポジトリを展開する。</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://gitlab.mintsys.jp/midev/misrc_distributed_computing_assist_api
$ cd misrc_distributed_computing_assist_api
$ ls
README.md  logging.cfg     mi_dicomapi_infomations.py           syslogs
debug      mi_dicomapi.py  mi_distributed_computing_assist.ini
$ cd debug
$ ls
api_status.py  api_status_gui.py  api_status_gui.pyc  mi-system-side  remote-side
$ cd remote-side
$ ls
api-debug.py  debug_gui.py  mi-system-remote.py
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>mi-system-remote.pyを実行する</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python mi-system-remote.py &lt;ホスト情報&gt; https://nims.mintsys.jp &lt;API token&gt;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id25">
<h3><span class="section-number">4.4.3. </span>(参考)MInt側作業<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>misrc_distributed_computing_assist_apiリポジトリを展開する。</p></li>
<li><p>mi_dicomapi.pyが未動作であれば、mi_distributed_computing_assist.iniに外部計算機の設定を実施する。動作中であれば、設定を再読み込みする。</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python
&gt;&gt;&gt; import requests
&gt;&gt;&gt; session = requests.Session()
&gt;&gt;&gt; ret = session.post(&quot;https://nims.mintsys.jp/reload-ini&quot;)
&gt;&gt;&gt;
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>mi_dicomapi.pyを動作させて待ち受け状態にする。</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python mi_dicomapi.py
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>モジュールの実行プログラム内で、misrc_distributed_computing_assist_api/debug/mi-system-side/mi-system-wf.py を必要なパラメータとともに実行するように構成する。</p></li>
</ol>
</div>
<div class="section" id="sample">
<span id="id26"></span><h3><span class="section-number">4.4.4. </span>その他MInt側注意事項<a class="headerlink" href="#sample" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>pbsNodeGroup設定でssh-node01を設定する。他の計算機では外へアクセスすることができないため。</p></li>
<li><p>pbsQueueなどCPU数などは指定できない。</p></li>
<li><p>外部計算機側で別途Torqueなどのバッチジョブシステムに依存する。</p></li>
</ul>
</div>
</div>
<div class="section" id="id27">
<h2><span class="section-number">4.5. </span>ワークフローの廃止<a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ユーザがMInt運用チームにワークフローの廃止届を提出する。当該ワークフローはMInt上で「無効」のステータスを付与され参照・実行不能となる。</p>
<p>以上</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">外部計算資源の利用について</a></h1>








<h3>ナビゲーション</h3>
<p class="caption"><span class="caption-text">目次:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="#id2">2. 概要</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id3">2.1. 利用イメージ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sshwebapi">2.2. SSH方式とWebAPI方式の比較</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id5">3. 動作原理</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ssh">3.1. SSH方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.1.1. 動作イメージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.1.2. ワークフロー例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">3.1.3. モジュール内の処理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#webapi">3.2. WebAPI方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.2.1. 動作イメージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.2.2. ワークフロー例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">3.2.3. モジュール内の処理</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-to-use">4. 使用方法</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#before-descide-items">4.1. 事前決定事項</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ssh-webapi">4.2. SSH, WebAPI方式共通</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id16">4.2.1. 資材の入手</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">4.2.2. ワークフローサンプル</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id19">4.3. SSH方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id20">4.3.1. 公開鍵の用意</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">4.3.2. 資材の展開</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mint">4.3.3. (参考)MInt側作業</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id22">4.4. WebAPI方式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id23">4.4.1. 認証関連情報の用意</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">4.4.2. 資材の展開</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">4.4.3. (参考)MInt側作業</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sample">4.4.4. その他MInt側注意事項</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id27">4.5. ワークフローの廃止</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="前の章へ">外部計算資源の利用方法（本運用）</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, SIP-MI.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/using_distributed_properties.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>